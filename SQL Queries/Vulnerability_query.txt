
SELECT  timestamp,
         asset_id,
         site_id,
       favf.vulnerability_instances,
        favf.vulnerability_id as signature_id,
        favf.risk_score,
         dv.title as signature ,
        dv.severity,
        dv.cvss_score as cvss,
        dv.cvss_vector,
        dv.date_added,
        dv.date_published,
        dvc.categories as category,
         dve.skill_level,
        dvr.other_references,
         da.ip_address as dest,
         da.mac_address as mac,
        da.host_name,
        fv.first_discovered,
         fv.most_recently_discovered,
        solution_summary,
         solution_count,
         solution_types
FROM dim_site_asset
RIGHT JOIN 
    (SELECT favf.date AS timestamp,
        favf.asset_id ,
         favf.vulnerability_instances ,
         favf.vulnerability_id ,
         favf.risk_score 
    FROM fact_asset_vulnerability_finding as favf) as favf USING(asset_id)
LEFT JOIN 
    (SELECT fv.vulnerability_id,
        fv.first_discovered,
         fv.most_recently_discovered
    FROM fact_vulnerability as fv) as fv USING(vulnerability_id)
LEFT JOIN 
    (SELECT ds.site_id,
        ds.name,
         ds.scan_template,
        ds.scan_engine
    FROM dim_site as ds) as ds USING(site_id)
LEFT JOIN 
    (SELECT dv.vulnerability_id ,
         dv.title ,
         dv.severity,
         dv.cvss_score,
         dv.cvss_vector,
         dv.date_added,
         dv.date_published
    FROM dim_vulnerability as dv) as dv USING(vulnerability_id)
LEFT JOIN 
    (SELECT dvc.vulnerability_id,
         (string_agg(DISTINCT dvc.category_name,
        ';')) AS categories
    FROM dim_vulnerability_category dvc
    GROUP BY  dvc.vulnerability_id) dvc
USING (vulnerability_id)
LEFT JOIN 
    (SELECT dve.vulnerability_id,
         dve.skill_level AS skill_level
    FROM dim_vulnerability_exploit dve) dve
USING (vulnerability_id)
LEFT JOIN 
    (SELECT dvr.vulnerability_id,
         (string_agg(DISTINCT dvr.source || ';' || dvr.reference,';')) AS other_references
    FROM dim_vulnerability_reference dvr
    GROUP BY  dvr.vulnerability_id) dvr
USING (vulnerability_id)
LEFT JOIN 
    (SELECT da.asset_id,
         da.ip_address,
         da.mac_address,
         da.host_name
    FROM dim_asset da) da
USING (asset_id)
LEFT JOIN 
    (SELECT vulnerability_id,
        (array_agg(summary))[1] AS solution_summary,
         COUNT(solution_id) AS solution_count,
         string_agg(distinct(solution_type),
        '|') AS solution_types
    FROM dim_vulnerability_solution
    JOIN 
        (SELECT solution_id,
         solution_type,
         summary
        FROM dim_solution) dsol
        USING (solution_id)
        GROUP BY  vulnerability_id) dsv
    USING (vulnerability_id) 
WHERE timestamp > ?
ORDER BY timestamp ASC